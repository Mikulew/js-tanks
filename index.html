<!DOCTYPE html>
<html lang="pl">
<head>
  <title>Tanks JS</title>
  <meta charset="UTF-8" />
  <style>
    canvas { background: #333; display: block; margin: 0 auto; cursor: crosshair; }
    #ui { color: white; text-align: center; font-family: monospace; margin-top: 5px; }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="600"></canvas>
  <div id="ui">HP: <span id="hp">100</span> | Ammo: <span id="ammo">100</span></div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const hpEl = document.getElementById("hp");
    const ammoEl = document.getElementById("ammo");

    const tank = {
      x: 400,
      y: 300,
      speed: 3,
      angle: 0,
      hp: 100,
      ammo: 100
    };

    let myId = null;
    const otherPlayers = new Map(); // id => {x, y, angle, hp, ammo, color}
    let lastSent = { x: tank.x, y: tank.y, angle: tank.angle };

    const socket = new WebSocket("ws://localhost:9999");

    socket.addEventListener("open", () => {
      console.log("✅ Połączono z serwerem!");
    });

    socket.addEventListener("message", (event) => {
      const lines = event.data.trim().split("\n");

      for (const line of lines) {
        if (line.startsWith("MY_ID ")) {
          myId = line.split(" ")[1];
          console.log("Moje ID:", myId);
        }
        else if (line.startsWith("PLAYER ")) {
          const parts = line.split(" ");
          const id = parts[1];
          const x = parseFloat(parts[2]);
          const y = parseFloat(parts[3]);
          const angle = parseFloat(parts[4]);
          const hp = parseInt(parts[5]);
          const ammo = parseInt(parts[6]);
          const color = parts[7];

          if (id === myId) {
            // To ja – aktualizuj tylko UI
            tank.hp = hp;
            tank.ammo = ammo;
            hpEl.textContent = hp;
            ammoEl.textContent = ammo;
          } else {
            // Inny gracz
            otherPlayers.set(id, { x, y, angle, hp, ammo, color });
          }
        }
      }
    });

    function sendMove() {
      const dx = tank.x - lastSent.x;
      const dy = tank.y - lastSent.y;
      const angle = tank.angle;

      if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1 || Math.abs(angle - lastSent.angle) > 0.01) {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(`MOVE ${dx} ${dy} ${angle}`);
          lastSent = { x: tank.x, y: tank.y, angle };
        }
      }
    }

    function shoot() {
      if (tank.ammo > 0 && socket.readyState === WebSocket.OPEN) {
        socket.send("SHOOT");
      }
    }

    const keys = {};
    document.addEventListener("keydown", (e) => { keys[e.key] = true; });
    document.addEventListener("keyup", (e) => { keys[e.key] = false; });

    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      tank.angle = Math.atan2(mouseY - tank.y, mouseX - tank.x);
    });

    canvas.addEventListener("mousedown", (e) => {
      if (e.button === 0) shoot();
    });

    canvas.addEventListener("contextmenu", (e) => e.preventDefault());

    function update() {
      let moved = false;
      if (keys["ArrowUp"] || keys["w"] || keys["W"]) { tank.y -= tank.speed; moved = true; }
      if (keys["ArrowDown"] || keys["s"] || keys["S"]) { tank.y += tank.speed; moved = true; }
      if (keys["ArrowLeft"] || keys["a"] || keys["A"]) { tank.x -= tank.speed; moved = true; }
      if (keys["ArrowRight"] || keys["d"] || keys["D"]) { tank.x += tank.speed; moved = true; }

      if (moved) sendMove();
    }

    function drawTank(x, y, angle, color, label = "") {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(angle);
      ctx.fillStyle = color;
      ctx.fillRect(-20, -15, 40, 30); // korpus
      ctx.fillRect(20, -3, 20, 6);   // lufa
      ctx.restore();

      // Etykieta (ID gracza) nad czołgiem
      if (label) {
        ctx.fillStyle = "white";
        ctx.font = "12px monospace";
        ctx.textAlign = "center";
        ctx.fillText(label, x, y - 25);
      }
    }

    function gameLoop() {
      update();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Rysuj innych graczy
      for (const [id, p] of otherPlayers) {
        drawTank(p.x, p.y, p.angle, p.color, id); // ID jako etykieta
      }

      // Rysuj siebie (zielony)
      drawTank(tank.x, tank.y, tank.angle, "lime");

      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>